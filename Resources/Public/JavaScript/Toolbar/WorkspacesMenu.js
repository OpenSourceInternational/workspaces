/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
var __awaiter=this&&this.__awaiter||function(e,t,o,a){return new(o||(o=Promise))((function(r,n){function s(e){try{i(a.next(e))}catch(e){n(e)}}function c(e){try{i(a.throw(e))}catch(e){n(e)}}function i(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(s,c)}i((a=a.apply(e,t||[])).next())}))};define(["require","exports","jquery","TYPO3/CMS/Core/Ajax/AjaxRequest","TYPO3/CMS/Backend/ModuleMenu","TYPO3/CMS/Backend/Viewport"],(function(e,t,o,a,r,n){"use strict";var s,c;!function(e){e.containerSelector="#typo3-cms-workspaces-backend-toolbaritems-workspaceselectortoolbaritem",e.activeMenuItemLinkSelector=".dropdown-menu .selected",e.menuItemSelector=".t3js-workspace-item",e.menuItemLinkSelector=".t3js-workspaces-switchlink",e.toolbarItemSelector=".dropdown-toggle",e.workspaceModuleLinkSelector=".t3js-workspaces-modulelink"}(s||(s={})),function(e){e.workspaceBodyClass="typo3-in-workspace",e.workspacesTitleInToolbarClass="toolbar-item-name"}(c||(c={}));class i{static refreshPageTree(){n.NavigationContainer&&n.NavigationContainer.PageTree&&n.NavigationContainer.PageTree.refreshTree()}static updateTopBar(e){if(o("."+c.workspacesTitleInToolbarClass,s.containerSelector).remove(),e&&e.length){let t=o("<span>",{class:c.workspacesTitleInToolbarClass}).text(e);o(s.toolbarItemSelector,s.containerSelector).append(t)}}static updateBackendContext(e=""){let t="";TYPO3.configuration.inWorkspace?(o("body").addClass(c.workspaceBodyClass),t=e||TYPO3.lang["Workspaces.workspaceTitle"]):o("body").removeClass(c.workspaceBodyClass),i.updateTopBar(t)}constructor(){n.Topbar.Toolbar.registerEvent(()=>{this.initializeEvents(),i.updateBackendContext()})}performWorkspaceSwitch(e,t){top.TYPO3.Backend.workspaceTitle=t,top.TYPO3.configuration.inWorkspace=0!==e,i.updateBackendContext(t);o(s.activeMenuItemLinkSelector+" i",s.containerSelector).removeClass("fa fa-check").addClass("fa fa-empty-empty"),o(s.activeMenuItemLinkSelector,s.containerSelector).removeClass("selected");const a=o(s.menuItemLinkSelector+"[data-workspaceid="+e+"]",s.containerSelector).closest(s.menuItemSelector);a.find("i").removeClass("fa fa-empty-empty").addClass("fa fa-check"),a.addClass("selected")}initializeEvents(){o(s.containerSelector).on("click",s.workspaceModuleLinkSelector,e=>{e.preventDefault(),r.App.showModule(e.currentTarget.dataset.module)}),o(s.containerSelector).on("click",s.menuItemLinkSelector,e=>{e.preventDefault(),this.switchWorkspace(parseInt(e.currentTarget.dataset.workspaceid,10))})}switchWorkspace(e){new a(TYPO3.settings.ajaxUrls.workspace_switch).post({workspaceId:e,pageId:top.fsMod.recentIds.web}).then(e=>__awaiter(this,void 0,void 0,(function*(){const t=yield e.resolve();if(t.workspaceId||(t.workspaceId=0),this.performWorkspaceSwitch(parseInt(t.workspaceId,10),t.title),t.pageId){top.fsMod.recentIds.web=t.pageId;let e=TYPO3.Backend.ContentContainer.getUrl();e+=(e.includes("?")?"&":"?")+"&id="+t.pageId,i.refreshPageTree(),n.ContentContainer.setUrl(e)}else top.currentModuleLoaded.startsWith("web_")?(i.refreshPageTree(),r.App.reloadFrames()):TYPO3.configuration.pageModule&&r.App.showModule(TYPO3.configuration.pageModule);r.App.refreshMenu()})))}}const l=new i;return TYPO3.WorkspacesMenu=l,l}));