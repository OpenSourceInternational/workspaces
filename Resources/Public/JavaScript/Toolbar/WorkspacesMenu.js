/*
 * This file is part of the TYPO3 CMS project.
 *
 * It is free software; you can redistribute it and/or modify it under
 * the terms of the GNU General Public License, either version 2
 * of the License, or any later version.
 *
 * For the full copyright and license information, please read the
 * LICENSE.txt file that was distributed with this source code.
 *
 * The TYPO3 project - inspiring people to share!
 */
define(["require","exports","jquery","TYPO3/CMS/Backend/ModuleMenu","TYPO3/CMS/Backend/Viewport"],function(e,t,o,a,r){"use strict";var n,s,c,i;(s=n||(n={})).containerSelector="#typo3-cms-workspaces-backend-toolbaritems-workspaceselectortoolbaritem",s.activeMenuItemLinkSelector=".dropdown-menu .selected",s.menuItemSelector=".t3js-workspace-item",s.menuItemLinkSelector=".t3js-workspaces-switchlink",s.toolbarItemSelector=".dropdown-toggle",s.workspaceModuleLinkSelector=".t3js-workspaces-modulelink",(i=c||(c={})).workspaceBodyClass="typo3-in-workspace",i.workspacesTitleInToolbarClass="toolbar-item-name";var p=new(function(){function e(){var t=this;r.Topbar.Toolbar.registerEvent(function(){t.initializeEvents(),e.updateBackendContext()})}return e.refreshPageTree=function(){r.NavigationContainer&&r.NavigationContainer.PageTree&&r.NavigationContainer.PageTree.refreshTree()},e.updateTopBar=function(e){if(o("."+c.workspacesTitleInToolbarClass,n.containerSelector).remove(),e&&e.length){var t=o("<span>",{class:c.workspacesTitleInToolbarClass}).text(e);o(n.toolbarItemSelector,n.containerSelector).append(t)}},e.updateBackendContext=function(t){void 0===t&&(t="");var a="";TYPO3.configuration.inWorkspace?(o("body").addClass(c.workspaceBodyClass),a=t||TYPO3.lang["Workspaces.workspaceTitle"]):o("body").removeClass(c.workspaceBodyClass),e.updateTopBar(a)},e.prototype.performWorkspaceSwitch=function(t,a){top.TYPO3.Backend.workspaceTitle=a,top.TYPO3.configuration.inWorkspace=0!==t,e.updateBackendContext(a);var r="fa fa-check",s="fa fa-empty-empty";o(n.activeMenuItemLinkSelector+" i",n.containerSelector).removeClass(r).addClass(s),o(n.activeMenuItemLinkSelector,n.containerSelector).removeClass("selected");var c=o(n.menuItemLinkSelector+"[data-workspaceid="+t+"]",n.containerSelector).closest(n.menuItemSelector);c.find("i").removeClass(s).addClass(r),c.addClass("selected")},e.prototype.initializeEvents=function(){var e=this;o(n.containerSelector).on("click",n.workspaceModuleLinkSelector,function(e){e.preventDefault(),a.App.showModule(e.currentTarget.dataset.module)}),o(n.containerSelector).on("click",n.menuItemLinkSelector,function(t){t.preventDefault(),e.switchWorkspace(parseInt(t.currentTarget.dataset.workspaceid,10))})},e.prototype.switchWorkspace=function(t){var n=this;o.ajax({url:TYPO3.settings.ajaxUrls.workspace_switch,type:"post",data:{workspaceId:t,pageId:top.fsMod.recentIds.web},success:function(t){if(t.workspaceId||(t.workspaceId=0),n.performWorkspaceSwitch(parseInt(t.workspaceId,10),t.title),t.pageId){top.fsMod.recentIds.web=t.pageId;var o=TYPO3.Backend.ContentContainer.getUrl();o+=(-1===o.indexOf("?")?"?":"&")+"&id="+t.pageId,e.refreshPageTree(),r.ContentContainer.setUrl(o)}else 0===top.currentModuleLoaded.indexOf("web_")?(e.refreshPageTree(),a.App.reloadFrames()):TYPO3.configuration.pageModule&&a.App.showModule(TYPO3.configuration.pageModule);a.App.refreshMenu()}})},e}());return TYPO3.WorkspacesMenu=p,p});